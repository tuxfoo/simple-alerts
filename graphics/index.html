<!DOCTYPE html>
<html lang="en">
<head>
  <title>simple-alerts</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/tip.css"/>
  <link rel="stylesheet" href="css/animate.css"/>
  <link rel="stylesheet" href="css/text-animations.css"/>
</head>
<body>
  <div id="alert-wrapper">
    <div id="alert-image-wrap">
    <div id="alert-image" style="background-image: none;">

    </div>

    <div id="alert-text-wrap">

      <div id="alert-text">

        <div id="alert-message">

          <div id="alert-user-message" class="animate__animated animate__tada" style='font-size: 64px; color: rgb(255, 255, 255); font-family: "Palanquin"; font-weight: 800;'></div>
        </div>
      </div>
    </div>
</div>
  <script>
    function sleep(ms) {
    return new Promise(
      resolve => setTimeout(resolve, ms)
    );
    }
    function animateText(word) {
      var span = document.createElement("span");
      span.setAttribute("style", "color: rgb(79, 230, 57); position: relative;");
      for (var i = 0; i < word.length; i++) {
        var letter = document.createElement("span");
        letter.setAttribute("class", "animated-letter rubberBand");
        letter.appendChild(document.createTextNode(word.charAt(i)));
        span.appendChild(letter);
      }
      return span;
    }
    var alertMessage = document.getElementById("alert-message");

    const activeAlert = nodecg.Replicant('activeAlert');
    const message = nodecg.Replicant('alerts');
    const media = nodecg.Replicant('assets:media-graphics');
    var div = document.getElementById('alert-wrapper');
    message.on('change', value => {
      // Should add a isAlertPlaying function to queue alerts.
      if (div.style.display === "none") {
        div.style.display = "block";
      }
      // Handle media
      media.on('change', v => {
        console.log("Alert has media:");
        console.log(v[value[activeAlert.value].media].ext);

        if (v[value[activeAlert.value].media].ext === ".webm") {
          console.log("isVideo");
          var video = document.createElement("video");
          video.setAttribute("id", "webm-video");
          video.setAttribute("autoplay", "autoplay");
          video.setAttribute("muted", "muted");
          video.setAttribute("loop", "loop");
          video.setAttribute("src", v[value[activeAlert.value].media].url);
          document.getElementById('alert-image').appendChild(video)
          document.getElementById('webm-video').play();
        }
      });
      var duration = value[activeAlert.value].duration;
      var re = /\(.*?\)/g;
      var message = value[activeAlert.value].message;
      var keywords = message.matchAll(re);
      var userMessage = document.getElementById('alert-user-message');
      message = message.replace(re, "");
      var count = 0;
      var lastKeyword = 0;
      for ( var keyword of keywords ) {
        console.log(keyword.index);
        // Check to see if a keyword is first in message.
        if ( keyword.index != 0 ) {
          var messageElement = document.createElement("span");
          var messageText = document.createTextNode(message.slice(0, keyword.index + count));
          count = count - (keyword[0].length + keyword.index);
          message = message.replace(message.slice(0, keyword.index), "");
          messageElement.appendChild(messageText);
          userMessage.appendChild(messageElement);
        } else {
          count = count - (keyword[0].length + keyword.index);
        }
        keyword[0] = keyword[0].replace("(", "");
        keyword[0] = keyword[0].replace(")", "");
        userMessage.appendChild(animateText(keyword[0]));
        lastKeyword = keyword.index + keyword[0].length + 2;
      }
      // If a keyword is not last, add the rest of the message.
      if ( lastKeyword < value[activeAlert.value].message.length ) {
        messageElement = document.createElement("span");
        messageText = document.createTextNode(value[activeAlert.value].message.slice(lastKeyword, value[activeAlert.value].message.length));
        messageElement.appendChild(messageText);
        userMessage.appendChild(messageElement);
      }
      sleep(duration).then(() => {
          div.style.display = "none";
          if (media.value[value[activeAlert.value].media].ext === ".webm") {
            var video = document.getElementById('webm-video');
            video.parentNode.removeChild(video);
          }
          console.log("HIDE");
      });
    });
  </script>
</body>
</html>
