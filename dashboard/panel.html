<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
  <div id=alerts-wrap>
  </div>
  <form id="newAlert">
     <button type="submit">Add New Alert</button>
  </form>
	<script>
    const alerts = nodecg.Replicant('alerts');
    const art = nodecg.Replicant('assets:media-graphics');
    // If the change is removal, do not run showPanels
    var removeChange = false;
    // Iterate thru each user created alert and generate a menu.
    alerts.on('change', value => {
      console.log("changed");
      if (removeChange == false) {
        value.forEach(showPanels);
      } else {
        removeChange = false;
      }
    });

    function showPanels(value, index, array) {
      var alreadyExists = document.getElementById('alert' + index)
      const div = document.getElementById('alerts-wrap');
      console.log("creating " + index);
      var form = document.createElement('form');
      form.setAttribute('id', 'alert' + index);
      var name = document.createElement('label');
      name.setAttribute('for', 'alert' + index + 'Name');
      var nameLabel = document.createTextNode("Alert Name: ");
      name.appendChild(nameLabel);
      var nameInput = document.createElement('input');
      nameInput.setAttribute('id', 'alert' + index + 'Name');
      var str = document.createElement('label');
      str.setAttribute('for', 'str' + index);
      var strLabel = document.createTextNode("Place test message here, place keywords in curly brackets.");
      str.appendChild(strLabel);
      var strInput = document.createElement('input');
      strInput.setAttribute('id', 'str' + index);
      var alertSubmit = document.createElement('button');
      alertSubmit.setAttribute('type', 'submit');
      alertSubmit.setAttribute('id', 'submitBtn' + index);
      var buttonLabel = document.createTextNode("Submit");
      alertSubmit.appendChild(buttonLabel);
      var alertDelete = document.createElement('button');
      var deleteWrap = document.createElement('div');
      alertDelete.setAttribute('id', 'deleteBtn' + index);
      var deleteLabel = document.createTextNode("DELETE");
      alertDelete.appendChild(deleteLabel);
      var durationLabel = document.createElement('label');
      durationLabel.setAttribute('for', 'duration' + index);
      durationLabel.appendChild(document.createTextNode("Duration of Alert in seconds: "));
      var duration = document.createElement('input');
      duration.setAttribute('id', 'duration' + index);

      // Menu for graphics
      var select = document.createElement('select');
      select.setAttribute('id', 'select' + index);
      var selectLabel = document.createElement('label');
      selectLabel.setAttribute('for', 'select' + index);
      selectLabel.appendChild(document.createTextNode("Media"));
      art.on('change', v => {
        v.forEach(populateList);
      });

      // Menu for layouts
      var selectLayout = document.createElement('select');
      selectLayout.setAttribute('id', 'selectLayout' + index);
      var selectLayoutLabel = document.createElement('label');
      selectLayoutLabel.setAttribute('for', 'selectLayout' + index);
      selectLayoutLabel.appendChild(document.createTextNode('Layout'));

      // Layout options
      var layoutOption = document.createElement('option');
      layoutOption.setAttribute('value', 0);
      var layoutOptionLabel = document.createTextNode('banner');
      layoutOption.appendChild(layoutOptionLabel);
      selectLayout.appendChild(layoutOption);
      layoutOption = document.createElement('option')
      layoutOption.setAttribute('value', 1);
      layoutOptionLabel = document.createTextNode('side');
      layoutOption.appendChild(layoutOptionLabel);
      selectLayout.appendChild(layoutOption);

      // Create form for alert
      form.appendChild(name);
      form.appendChild(nameInput);
      form.appendChild(document.createElement("br"));
      form.appendChild(str);
      form.appendChild(document.createElement("br"));
      form.appendChild(strInput);
      form.appendChild(document.createElement("br"));
      form.appendChild(selectLabel);
      form.appendChild(select);
      form.appendChild(document.createElement("br"));
      form.appendChild(durationLabel);
      form.appendChild(duration);
      form.appendChild(document.createElement("br"));
      form.appendChild(selectLayoutLabel);
      form.appendChild(selectLayout);
      form.appendChild(document.createElement("br"));
      form.appendChild(alertSubmit);
      form.appendChild(alertDelete);

      div.appendChild(form);

      // Load the saved settings
      document.getElementById('alert' + index + 'Name').value = value.name;
      document.getElementById('str' + index).value = value.message;
      document.getElementById('duration' + index).value = toSeconds(value.duration);
      document.getElementById('select' + index).value = value.media;
      document.getElementById('selectLayout' + index).value = value.layout;
      // Delete alert
      document.getElementById('deleteBtn' + index).addEventListener('click', e => {
        console.log("remove " + index);
        alerts.value.splice(index, 1);
        removeChange = false;
      });
      // Save changes
      document.getElementById('submitBtn' + index).addEventListener('click', e => {
        e.preventDefault();
        console.log("Submit alert " + index)
        value.name = document.getElementById('alert' + index + 'Name').value;
        value.message = document.getElementById('str' + index).value;
        value.duration = toMS(document.getElementById('duration' + index).value);
        value.media = document.getElementById('select' + index).value;
        value.layout = document.getElementById('selectLayout' + index).value;
        removeChange = true;
      });
      // Populate the graphic asset menu
      function populateList(value, index, array) {
        var option = document.createElement('option');
        option.setAttribute('value', index);
        var optionLabel = document.createTextNode(value.base);
        option.appendChild(optionLabel);
        select.appendChild(option);
      }

      // Conversions
      function toSeconds(ms) {
        return ms / 1000;
      }
      function toMS(seconds) {
        return seconds * 1000;
      }
    }
    // Create a new alert.
    document.getElementById('newAlert').addEventListener('click', e => {
      alerts.value.push({name: 'Alert1', message: '(name) just tipped (amount) (currency)', duration: 5000});
    });
	</script>
</body>
</html>
