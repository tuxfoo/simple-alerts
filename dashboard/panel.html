<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
  <div id=alerts-wrap>
  </div>
  <form id="newAlert">
     <button type="submit">Add New Alert</button>
  </form>
	<script>
    const alerts = nodecg.Replicant('alerts');
    const art = nodecg.Replicant('assets:media-graphics');
    const sound = nodecg.Replicant('assets:media-sounds');

    NodeCG.waitForReplicants(alerts, art, sound).then(() => {
      alerts.value.forEach(showPanels);
    });

    function showPanels(value, index, array) {
      var alreadyExists = document.getElementById('alert' + index)
      const div = document.getElementById('alerts-wrap');
      console.log("creating " + index);
      var form = document.createElement('form');
      form.setAttribute('id', 'alert' + index);
      var name = document.createElement('label');
      name.setAttribute('for', 'alert' + index + 'Name');
      var nameLabel = document.createTextNode("Alert Name: ");
      name.appendChild(nameLabel);
      var nameInput = document.createElement('input');
      nameInput.setAttribute('id', 'alert' + index + 'Name');
      var str = document.createElement('label');
      str.setAttribute('for', 'str' + index);
      var strLabel = document.createTextNode("Place test message here, place keywords in curly brackets.");
      str.appendChild(strLabel);
      var strInput = document.createElement('input');
      strInput.setAttribute('id', 'str' + index);
      var alertSubmit = document.createElement('button');
      alertSubmit.setAttribute('type', 'submit');
      alertSubmit.setAttribute('id', 'submitBtn' + index);
      var buttonLabel = document.createTextNode("Submit");
      alertSubmit.appendChild(buttonLabel);
      var alertDelete = document.createElement('button');
      var deleteWrap = document.createElement('div');
      alertDelete.setAttribute('id', 'deleteBtn' + index);
      var deleteLabel = document.createTextNode("DELETE");
      alertDelete.appendChild(deleteLabel);
      var durationLabel = document.createElement('label');
      durationLabel.setAttribute('for', 'duration' + index);
      durationLabel.appendChild(document.createTextNode("Duration of Alert in seconds: "));
      var duration = document.createElement('input');
      duration.setAttribute('id', 'duration' + index);

      var keywordColourLabel = document.createElement('label');
      keywordColourLabel.setAttribute('for', 'keywordColour' + index);
      keywordColourLabel.appendChild(document.createTextNode("Keyword Colour: "));
      var keywordColour = document.createElement('input');
      keywordColour.setAttribute('id', 'keywordColour' + index);

      var fontColourLabel = document.createElement('label');
      fontColourLabel.setAttribute('for', 'fontColour' + index);
      fontColourLabel.appendChild(document.createTextNode("Font Colour: "));
      var fontColour= document.createElement('input');
      fontColour.setAttribute('id', 'fontColour' + index);

      var customCSSLabel = document.createElement('label');
      customCSSLabel.setAttribute('for', 'customCSS' + index);
      customCSSLabel.appendChild(document.createTextNode("Custom CSS: "));
      var customCSS = document.createElement('textarea');
      customCSS.setAttribute('id', 'customCSS' + index);

      // Menu for graphics
      var select = document.createElement('select');
      select.setAttribute('id', 'select' + index);
      var selectLabel = document.createElement('label');
      selectLabel.setAttribute('for', 'select' + index);
      selectLabel.appendChild(document.createTextNode("Media: "));
      art.on('change', v => {
        v.forEach(populateList);
      });

      var selectSound = document.createElement('select');
      selectSound.setAttribute('id', 'select-sound' + index);
      var selectSoundLabel = document.createElement('label');
      selectSoundLabel.setAttribute('for', 'select-sound' + index);
      selectSoundLabel.appendChild(document.createTextNode("Sound: "));
      sound.on('change', v => {
        v.forEach(populateSoundList);
      });

      var volumeLabel = document.createElement('label');
      volumeLabel.setAttribute('for', 'volume' + index);
      volumeLabel.appendChild(document.createTextNode("/100"));
      var volume = document.createElement('input');
      volume.setAttribute('id', 'volume' + index);

      // Menu for layouts
      var selectLayout = document.createElement('select');
      selectLayout.setAttribute('id', 'selectLayout' + index);
      var selectLayoutLabel = document.createElement('label');
      selectLayoutLabel.setAttribute('for', 'selectLayout' + index);
      selectLayoutLabel.appendChild(document.createTextNode('Layout: '));

      // Layout options
      var layoutOption = document.createElement('option');
      layoutOption.setAttribute('value', 'banner');
      var layoutOptionLabel = document.createTextNode('banner');
      layoutOption.appendChild(layoutOptionLabel);
      selectLayout.appendChild(layoutOption);

      layoutOption = document.createElement('option')
      layoutOption.setAttribute('value', 'side');
      layoutOptionLabel = document.createTextNode('side');
      layoutOption.appendChild(layoutOptionLabel);
      selectLayout.appendChild(layoutOption);

      layoutOption = document.createElement('option')
      layoutOption.setAttribute('value', 'above');
      layoutOptionLabel = document.createTextNode('above');
      layoutOption.appendChild(layoutOptionLabel);
      selectLayout.appendChild(layoutOption);

      // Create form for alert
      form.appendChild(name);
      form.appendChild(nameInput);
      form.appendChild(document.createElement("br"));
      form.appendChild(str);
      form.appendChild(document.createElement("br"));
      form.appendChild(strInput);
      form.appendChild(document.createElement("br"));
      form.appendChild(selectLabel);
      form.appendChild(select);
      form.appendChild(document.createElement("br"));
      form.appendChild(durationLabel);
      form.appendChild(duration);
      form.appendChild(document.createElement("br"));
      form.appendChild(selectLayoutLabel);
      form.appendChild(selectLayout);
      form.appendChild(document.createElement("br"));
      form.appendChild(selectSoundLabel);
      form.appendChild(selectSound);
      form.appendChild(volume);
      form.appendChild(volumeLabel);
      form.appendChild(document.createElement("br"));
      form.appendChild(keywordColourLabel);
      form.appendChild(keywordColour);
      form.appendChild(fontColourLabel);
      form.appendChild(fontColour);
      form.appendChild(document.createElement("br"));
      form.appendChild(customCSSLabel);
      form.appendChild(document.createElement("br"));
      form.appendChild(customCSS);
      form.appendChild(document.createElement("br"));
      form.appendChild(alertSubmit);
      form.appendChild(alertDelete);

      div.appendChild(form);

      // Load the saved settings
      document.getElementById('alert' + index + 'Name').value = value.name;
      document.getElementById('str' + index).value = value.message;
      document.getElementById('duration' + index).value = toSeconds(value.duration);
      document.getElementById('select' + index).value = value.media;
      document.getElementById('selectLayout' + index).value = value.layout;
      document.getElementById('select-sound' + index).value = value.sound;
      document.getElementById('volume' + index).value = value.volume;

      // Delete alert
      document.getElementById('deleteBtn' + index).addEventListener('click', e => {
        console.log("remove " + index);
        alerts.value.splice(index, 1);
      });
      // Save changes
      document.getElementById('submitBtn' + index).addEventListener('click', e => {
        e.preventDefault();
        console.log("Submit alert " + index)
        value.name = document.getElementById('alert' + index + 'Name').value;
        value.message = document.getElementById('str' + index).value;
        value.duration = toMS(document.getElementById('duration' + index).value);
        value.media = document.getElementById('select' + index).value;
        value.layout = document.getElementById('selectLayout' + index).value;
        value.sound = document.getElementById('select-sound' + index).value;
        value.volume = document.getElementById('volume' + index).value;
      });
      // Populate the graphic asset menu

      function populateList(value, index, array) {
        var option = document.createElement('option');
        option.setAttribute('value', index);
        var optionLabel = document.createTextNode(value.base);
        option.appendChild(optionLabel);
        select.appendChild(option);
      }
      // I should combine this with graphic menu and make it work for all select menu's.
      // Populate the sound asset menu
      function populateSoundList(value, index, array) {
        var option = document.createElement('option');
        option.setAttribute('value', index);
        var optionLabel = document.createTextNode(value.base);
        option.appendChild(optionLabel);
        selectSound.appendChild(option);
      }

      // Conversions
      function toSeconds(ms) {
        return ms / 1000;
      }
      function toMS(seconds) {
        return seconds * 1000;
      }
    }
    // Create a new alert.
    document.getElementById('newAlert').addEventListener('click', e => {
      alerts.value.push({name: 'Alert1', message: '(name) just tipped (amount) (currency)', duration: 5000});
    });
	</script>
</body>
</html>
